<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
    .container {        
        transform: rotateY(0deg);
        width: 82px;
        height: 307px;
        margin-left: -41px;
        margin-top: -154px;
        -webkit-transition: -webkit-transform 1s;
        -moz-transition: -moz-transform 1s;
        transition: transform 1s;
        -webkit-transform-style: preserve-3d;
        -moz-transform-style: preserve-3d;
        transform-style: preserve-3d;
        position: absolute;
        left: 50%;
        top: 50%;
        border:1px solid green;
        /*border: 1px solid green;*/
    }
    #sword {
        width: 82px;
        height: 307px;
        background: url(img/sword.png) no-repeat center/100% 100%;       
    }

    .piece {
        top: 63px;
        left: -22px;
        width: 128px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, .5);
        -webkit-transition: opacity 1s, -webkit-transform 1s;
        -moz-transition: opacity 1s, -moz-transform 1s;
        transition: opacity 1s, transform 1s;
        position: absolute;
        bottom: 0;
        cursor: pointer;
    }

    #stage {
        margin-top: 200px;
        margin-left: 200px;
        border: 1px solid green;
        position: relative;
        width: 580px;
        height: 310px;
    }
    .content{
        width: 100px;
        height: 50px;
        border:1px solid blue;
    }
    </style>
</head>

<body>
    <input type="button" value="左" id='left'>
    <input type="button" value="右" id='right'>
    <input type="button" value="test" id='test'>
    <div id="stage" class="stage_area">
        <div id="container" class="container">
        </div>
    </div>
    <div class="content">
        
    </di>
    <script>
    document.querySelector('#test').addEventListener('click', function() {
        document.querySelector('#piece0').style['msTransform'] = 'scale(1, 1) rotateY(0deg) translateY(150px) translateZ(283.758px)';
        document.querySelector('#piece0').style['border'] = '5px solid yellow';
    });
    var coverImgArr = [
        "http://bookimg.haohuida.cn/cppartner/1x1/11x0/110x0/11000015896/11000015896.jpg",
        "http://bookimg.haohuida.cn/cppartner/1x1/11x0/110x0/11000073734/11000073734.jpg",
        "http://bookimg.haohuida.cn/cppartner/1x1/11x0/110x0/11000085140/11000085140.jpg",
        "http://bookimg.haohuida.cn/cppartner/1x1/11x0/110x0/11000006513/11000006513.jpg",
        "http://bookimg.haohuida.cn/cppartner/1x1/11x0/110x0/11000074417/11000074417.jpg",
        "http://bookimg.haohuida.cn/cppartner/1x1/11x0/110x0/11000074626/11000074626.jpg",
        "http://bookimg.haohuida.cn/cppartner/1x1/11x0/110x0/11000022939/11000022939.jpg",
        "http://bookimg.haohuida.cn/cppartner/1x1/11x0/110x0/11000074718/11000074718.jpg",
        "http://bookimg.haohuida.cn/cppartner/1x1/11x0/110x0/11000074766/11000074766.jpg"
    ];
    var bookData=      [{        
        novelName: '长生武侠',
        novelId: '11000015896',
        content: '长生武侠不长生，寂寞红尘独寂寞。自然红尘之中，武道流行。美女如云，却不能掩埋刀骨；天地沉重，却不能阻...',
    }, {
        
        novelName: '秦武侠佑',
        novelId: '11000073734',
        content: '英雄又如何？ 我自用大秦古武一一破之！ 且看大秦后裔杨宸以侠佑之名驰骋斗气魔法的世界！ ...',
    }, {       
        novelName: '武侠问道',
        novelId: '11000085140',
        content: '朝闻道，夕死可矣。武侠世界的道，又在哪里？一次又一次地轮转，又蕴含了什么样的秘密？古老的地球与洪荒，...',

    }, {
        novelName: '武道至尊',
        novelId: '11000092562',
        content: '废柴少年，无丝毫修武之材。 一代战神在他身上重生，从此天地大变！ 群雄俯首，众神称臣！ 武道至...',

    }, {       
        novelName: '戎武侠心',
        novelId: '11000006513',
        content: '当他身陨的时候，庙堂之上，南宋的开国皇帝赐其谥号“戎武”；江湖之远，市井民间，则喜欢在“戎武”之...',

    }, {       
        novelName: '穿越从武侠开始',
        novelId: '11000074417',
        content: '宇宙无边，时空无尽。 一个空间幻灭后的幸存者，转生到了射雕世界，成了王重阳的徒弟，这是他穿...',

    }
    , {       
        novelName: '求道武侠世界',
        novelId: '11000074626',
        content: '浪迹江湖，道在脚下，这是一个求道者的故事。...',

    }
    , {       
        novelName: '唐门宗师的武侠世界',
        novelId: '11000074766',
        content: '来到异世的惶恐不敌想要建立自己的千年宗门的雄心。 混乱的武林暗流汹涌，刀光血影。 本是内家拳弟子...',

    }
    , {       
        novelName: '我有一个武侠分身',
        novelId: '11000022939',
        content: '普通大学生赵容获得了另外一个世界中的武侠分身，可以于睡梦在武侠世界和现实世界中互相切换身体。他不仅体...',

    }, {       
        novelName: '大通天传',
        novelId: '11000074718',
        content: '虞沧海如此说：我今觉醒，生而神灵。天上地下，日月所照，风雨所至，皆唯我独尊。 玄奇宏大的世界，天地...',
    }
    ]
    var lib = {
        whichTransitionEvent: function() {
            var t;
            var el = document.createElement('fakeelement');
            var transitions = {
                'transition': 'transitionend',
                'OTransition': 'oTransitionEnd',
                'MozTransition': 'transitionend',
                'WebkitTransition': 'webkitTransitionEnd',
                'MsTransition': 'msTransitionEnd'
            }
            for (t in transitions) {
                if (el.style[t] !== undefined) {
                    return transitions[t];
                }
            }
        },
        init: function() {
            //最小值
            Array.prototype.min = function() {
                var min = this[0];
                var len = this.length;
                for (var i = 1; i < len; i++) {
                    if (this[i] < min) {
                        min = this[i];
                    }
                }
                return min;
            }
            //最大值
            Array.prototype.max = function() {
                var max = this[0];
                var len = this.length;
                for (var i = 1; i < len; i++) {
                    if (this[i] > max) {
                        max = this[i];
                    }
                }
                return max;
            }
        }
    }
    lib.init();
    var rotate = {
        $container: '',
        coverImgArr: [],
        arrNum: [],
        rotate: 0,
        indexPiece: 0,
        transZ: 0,
        nowpage: 0,
         autoPlay: false,
        //添加3d变换
        transform: function(element, value, key) {
            key = key || "Transform";
            ["moz", "o", "ms", "webkit", ""].forEach(function(prefix) {
                // console.log(prefix + key);
                element.style[prefix + key] = value;
            });

            return element;
        },
        // 浏览器选择器API
        $: function(selector) {
            return document.querySelector(selector);
        },
        $$: function(selector) {
            return document.querySelectorAll(selector);
        },
        getCoverImg:function(id){
            return "http://bookimg.haohuida.cn/cppartner/1x1/11x0/110x0/"+id+"/"+id+".jpg"
        },
        getUrl:function(id){
            return "http://blog.renren.com/ublog/fiction/"+id;
        },
        getScaleArray: function(arr, rotate, indexPiece) {
            var scaleArr = [];
            arr.forEach(function(item, index) {
                var transYItem = Math.sin((index * rotate + (-1 * rotate * indexPiece + 90)) * 2 * Math.PI / 360) * 50;
                scaleArr.push(transYItem);
            });
            var max = scaleArr.max();
            var min = scaleArr.min();
            scaleArr = scaleArr.map(function(item, index) {
                return (((1 - 0.7) / (max - min)) * item + (max * 0.7 - min * 1) / (max - min)).toFixed(2);
            });
            return scaleArr;
        },

        init: function(setting) {
            this.coverImgArr = setting.coverImgArr;
            this.$container = this.$(setting.container);
            this.render();
            this.bindEvent();
            this.startPlay();
        },

        render: function() {
            this.rotate = 360 / this.coverImgArr.length;
            // 显示图片
            var self=this;
            var htmlPic = '<div id="sword"></div>';
            this.coverImgArr.forEach(function(item, index) {
                htmlPic = htmlPic + '<img data="' + index + '" id="piece' + index + '" src="' + self.getCoverImg(item.novelId) + '" class="piece" />';
            });
            this.indexPiece = 0;
            var elePics = this.$$(".piece");
            this.transZ = 96 / Math.tan((this.rotate / 2 / 180) * Math.PI);
            this.$container.innerHTML = htmlPic;
            var scaleArr = this.getScaleArray(this.coverImgArr, this.rotate, this.indexPiece);
            //初始值
            var self = this;
            var helf = parseInt(this.coverImgArr.length / 2);
            this.coverImgArr.forEach(function(item, index) {
                var transYItem = Math.sin((index * self.rotate + (-1 * self.rotate * self.indexPiece + 90)) * 2 * Math.PI / 360) * 50;
                self.transform(self.$("#piece" + index), "scale(" + scaleArr[index] + "," + scaleArr[index] + ") rotateY(" + (index * self.rotate) + "deg)  translateY(" + transYItem + "px) translateZ(" + (self.transZ + 20) + "px)");
                //self.$("#piece" + index).style['zIndex']=Math.abs(helf-index);
                self.arrNum.push(index);
            });
            self.arrNum.forEach(function(item, index) {
                self.$("#piece" + item).style['zIndex'] = Math.abs(helf - index);
            });
            self.transform(self.$("#sword"), "translateZ(" + (self.transZ ) + "px)");
            self.$(" #sword").style['zIndex'] = parseInt(helf / 2);
            this.getNowPage();
        },
        clickMiddle: function() {
            alert(this.nowpage);
        },
        //判断点击的是中间，还是左边，还是右边
        getClickStatus: function(dataIndex) {
            var self = this;
            if (dataIndex == self.nowpage) {
                self.clickMiddle();
            } else {
                var helfLength = self.coverImgArr.length / 2;
                var n = self.getIntervalNum(dataIndex)
                if (self.nowpage > helfLength) {
                    if (dataIndex >= (self.nowpage - helfLength) && (dataIndex < self.nowpage)) {
                        self.rotateFun(1, n);
                    } else {
                        self.rotateFun(0, n);
                    }
                } else {
                    if (self.nowpage < dataIndex && dataIndex < (self.nowpage + helfLength)) {
                        self.rotateFun(0, n);
                    } else {
                        self.rotateFun(1, n);
                    }
                }
            }
        },
        startPlay: function() {
            var self = this;
            self.interval = setInterval(function() {
                self.rotateFun(0, 1);
            }, 1500);
        },
        stopPlay: function() {
            var self = this;
            if (!!self.interval) {
                clearInterval(self.interval);
            }
        },
        animationEnd:function(index){
            document.querySelector('.content').innerHTML=this.coverImgArr[index].novelName;
        },
        bindEvent: function() {
            var self = this;
            this.$("#stage").addEventListener("click", function(e) {
                var halfLength = self.coverImgArr.length / 2;
                if (e.target.className.indexOf('piece') < 0) {
                    return;
                }               
                var dataIndex = parseInt(e.target.getAttribute('data'));
                self.getClickStatus(dataIndex);
            });
            this.$("#left").addEventListener("click", function(e) {
                self.rotateFun(1, 1);
            });
            this.$("#right").addEventListener("click", function(e) {
                self.rotateFun(0, 1);
            });
            var itemList=self.$$('.piece');
            for (var i = 0; i < itemList.length; i++) {
                var item = itemList[i];
                item.addEventListener('mouseover', function() {
                    self.autoPlay = false;
                    self.stopPlay();
                });
                item.addEventListener('mouseout', function() {
                    self.autoPlay = true;
                    self.startPlay();
                });
            }
            if (self.autoPlay) {
                self.startPlay();
            }
             var transEndEventName = lib.whichTransitionEvent();
            document.querySelector('#piece0').addEventListener(transEndEventName, function(e) {
               // console.log(self.nowpage);
                 self.animationEnd(self.nowpage);                
            });
        },
        getNowPage: function() {
            var sign = this.indexPiece >= 0 ? true : false;
            this.nowpage = this.indexPiece % this.coverImgArr.length;
            if (this.nowpage < 0) {
                this.nowpage = this.nowpage + this.coverImgArr.length;
            }
            return this.nowpage;
        },
        getIntervalNum: function(num) {
            var arr = this.arrNum;
            var helf = parseInt(arr.length / 2);
            var result = -1;
            var tempNum = 0;
            var tempArr = [];
            var j = helf;
            arr.forEach(function(item, index) {
                if (item == num) {
                    result = index;
                }
            });
            if (arr.length % 2 == 1) {
                while (j > 0) {
                    tempArr.push(j);
                    tempArr.unshift(j);
                    j--;
                }
                tempArr.unshift(0);
            } else {
                tempArr.push(helf);
                j--;
                while (j > 0) {
                    tempArr.push(j);
                    tempArr.unshift(j);
                    j--;
                }
                tempArr.unshift(0);
            }

            return tempArr[result];
        },
        //status=1向右转，status=0向左转。
        rotateFun: function(status, n) {
            var self = this;
            
            if (status == 0) {
                //console.log(1);
                self.indexPiece = self.indexPiece + n;
                var temp = self.arrNum.splice(0, n);
                self.arrNum = self.arrNum.concat(temp);
            } else {
                self.indexPiece = self.indexPiece - n;
                var temp = self.arrNum.splice(-n, n);
                self.arrNum = temp.concat(self.arrNum);
                //self.arrNum.splice(0,0,temp);
            }
            var helf = parseInt(this.coverImgArr.length / 2);
            var bottom = self.nowpage < helf ? (helf + self.nowpage) : (self.nowpage - helf);
            var scaleArr = self.getScaleArray(self.coverImgArr, self.rotate, self.indexPiece);
            self.coverImgArr.forEach(function(item, index) {
                var transYItem = Math.sin((index * self.rotate + (-1 * self.rotate * self.indexPiece + 90)) * 2 * Math.PI / 360) * 50;
                self.transform(self.$("#piece" + index), "scale(" + scaleArr[index] + "," + scaleArr[index] + ") rotateY(" + parseFloat(index * self.rotate + (-1 * self.rotate * self.indexPiece)) + "deg)  translateY(" + transYItem + "px) translateZ(" + (self.transZ + 20) + "px)");

            });
            self.arrNum.forEach(function(item, index) {
                self.$("#piece" + item).style['zIndex'] = Math.abs(helf - index);
            });
            self.transform(self.$("#sword"), "translateZ(" + (self.transZ ) + "px)");
            self.$("#sword").style['zIndex'] = parseInt(helf / 2);
             self.getNowPage();
        },
    };
    rotate.init({
        coverImgArr: bookData,
        container: "#container",
    });
    </script>
</body>

</html>